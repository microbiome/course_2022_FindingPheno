<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Unsupervised learning | Introduction to multi-omics data analysis</title>
  <meta name="description" content="Workshop material" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Unsupervised learning | Introduction to multi-omics data analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Workshop material" />
  <meta name="github-repo" content="microbiome/course_2022_FindingPheno" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Unsupervised learning | Introduction to multi-omics data analysis" />
  
  <meta name="twitter:description" content="Workshop material" />
  

<meta name="author" content="University of Turku" />


<meta name="date" content="2022-01-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="beta-diversity.html"/>
<link rel="next" href="supervised-learning.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Introduction to multiomic data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#learning-goals-to-do"><i class="fa fa-check"></i><b>1.2</b> Learning goals [TO DO]</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i><b>1.3</b> Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="program.html"><a href="program.html"><i class="fa fa-check"></i><b>2</b> Program</a>
<ul>
<li class="chapter" data-level="2.1" data-path="program.html"><a href="program.html#day-1"><i class="fa fa-check"></i><b>2.1</b> Day 1</a></li>
<li class="chapter" data-level="2.2" data-path="program.html"><a href="program.html#day-2"><i class="fa fa-check"></i><b>2.2</b> Day 2</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>3</b> Getting started</a>
<ul>
<li class="chapter" data-level="3.1" data-path="getting-started.html"><a href="getting-started.html#checklist-before-the-workshop"><i class="fa fa-check"></i><b>3.1</b> Checklist (before the workshop)</a></li>
<li class="chapter" data-level="3.2" data-path="getting-started.html"><a href="getting-started.html#support-and-resources"><i class="fa fa-check"></i><b>3.2</b> Support and resources</a></li>
<li class="chapter" data-level="3.3" data-path="getting-started.html"><a href="getting-started.html#installing-and-loading-the-required-r-packages"><i class="fa fa-check"></i><b>3.3</b> Installing and loading the required R packages</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data.html"><a href="data.html#data-structure"><i class="fa fa-check"></i><b>4.1</b> Data structure</a></li>
<li class="chapter" data-level="4.2" data-path="data.html"><a href="data.html#example-data"><i class="fa fa-check"></i><b>4.2</b> Example data</a></li>
<li class="chapter" data-level="4.3" data-path="data.html"><a href="data.html#importing-data-in-r"><i class="fa fa-check"></i><b>4.3</b> Importing data in R</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="microbiome-data-exploration.html"><a href="microbiome-data-exploration.html"><i class="fa fa-check"></i><b>5</b> Microbiome data exploration</a>
<ul>
<li class="chapter" data-level="5.1" data-path="microbiome-data-exploration.html"><a href="microbiome-data-exploration.html#data-structure-1"><i class="fa fa-check"></i><b>5.1</b> Data structure</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="microbiome-data-exploration.html"><a href="microbiome-data-exploration.html#transformations"><i class="fa fa-check"></i><b>5.1.1</b> Transformations</a></li>
<li class="chapter" data-level="5.1.2" data-path="microbiome-data-exploration.html"><a href="microbiome-data-exploration.html#aggregation"><i class="fa fa-check"></i><b>5.1.2</b> Aggregation</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="microbiome-data-exploration.html"><a href="microbiome-data-exploration.html#visualization"><i class="fa fa-check"></i><b>5.2</b> Visualization</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="beta-diversity.html"><a href="beta-diversity.html"><i class="fa fa-check"></i><b>6</b> Beta diversity</a>
<ul>
<li class="chapter" data-level="6.1" data-path="beta-diversity.html"><a href="beta-diversity.html#examples-of-pcoa-with-different-settings"><i class="fa fa-check"></i><b>6.1</b> Examples of PCoA with different settings</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="beta-diversity.html"><a href="beta-diversity.html#pcoa-for-asv-level-data-with-bray-curtis"><i class="fa fa-check"></i><b>6.1.1</b> PCoA for ASV-level data with Bray-Curtis</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="beta-diversity.html"><a href="beta-diversity.html#highlighting-external-variables"><i class="fa fa-check"></i><b>6.2</b> Highlighting external variables</a></li>
<li class="chapter" data-level="6.3" data-path="beta-diversity.html"><a href="beta-diversity.html#estimating-associations-with-an-external-variable"><i class="fa fa-check"></i><b>6.3</b> Estimating associations with an external variable</a></li>
<li class="chapter" data-level="6.4" data-path="beta-diversity.html"><a href="beta-diversity.html#community-typing"><i class="fa fa-check"></i><b>6.4</b> Community typing</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="unsupervised-learning.html"><a href="unsupervised-learning.html"><i class="fa fa-check"></i><b>7</b> Unsupervised learning</a>
<ul>
<li class="chapter" data-level="7.1" data-path="unsupervised-learning.html"><a href="unsupervised-learning.html#biclustering"><i class="fa fa-check"></i><b>7.1</b> Biclustering</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="supervised-learning.html"><a href="supervised-learning.html"><i class="fa fa-check"></i><b>8</b> Supervised learning</a>
<ul>
<li class="chapter" data-level="8.1" data-path="supervised-learning.html"><a href="supervised-learning.html#random-forests"><i class="fa fa-check"></i><b>8.1</b> Random Forests</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="model-selection-and-evaluation.html"><a href="model-selection-and-evaluation.html"><i class="fa fa-check"></i><b>9</b> Model selection and evaluation</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Introduction to multi-omics data analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="unsupervised-learning" class="section level1" number="7">
<h1><span class="header-section-number">Chapter 7</span> Unsupervised learning</h1>
<p>Unsupervised learning is a part of machine learning where we try to find information
from unknown data. It is also called data mining. Usually this means finding of
clusters, for instance. Cluster refers to group of samples/features that are similar
between each other. For example, based on clinical data we can try to find patient
groups that have similar response to used drug.</p>
<div id="biclustering" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Biclustering</h2>
<p>Biclustering is a clustering method, which simultaneously clusters rows and columns.
In this example, the aim is to find clusters where subset of taxa share similar
pattern over subset of metabolites. In our case, we try to find clusters where
taxa and metabolites correlate similarly.</p>
<p>Check more from OMA which has dedicated chapter on
<a href="https://microbiome.github.io/OMA/biclustering.html">biclustering</a>.</p>
<p>First, we subset metabolite data so that it includes fewer metabolites. We use
coefficient of variation as a subset criteria. Meaning of this is that, if concentration
of metabolite does not vary, concentration does not differ between samples.</p>
<p>By doing that, we avoid unnecessary multiple testing, and we focus only on interesting
metabolites.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="unsupervised-learning.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb30-2"><a href="unsupervised-learning.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold: metabolites whose (cv &gt; +threshold or cv &lt; -threshold), will be included</span></span>
<span id="cb30-3"><a href="unsupervised-learning.html#cb30-3" aria-hidden="true" tabindex="-1"></a>cv_threshold <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb30-4"><a href="unsupervised-learning.html#cb30-4" aria-hidden="true" tabindex="-1"></a>metabolite_trans <span class="ot">&lt;-</span> <span class="st">&quot;nmr&quot;</span></span>
<span id="cb30-5"><a href="unsupervised-learning.html#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="unsupervised-learning.html#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data</span></span>
<span id="cb30-7"><a href="unsupervised-learning.html#cb30-7" aria-hidden="true" tabindex="-1"></a>metabolite_tse <span class="ot">&lt;-</span> mae[[<span class="dv">2</span>]]</span>
<span id="cb30-8"><a href="unsupervised-learning.html#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="unsupervised-learning.html#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate coefficient of variation of individual metabolites</span></span>
<span id="cb30-10"><a href="unsupervised-learning.html#cb30-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cv =</span> <span class="fu">apply</span>(<span class="fu">assay</span>(metabolite_tse, metabolite_trans), <span class="dv">1</span>, </span>
<span id="cb30-11"><a href="unsupervised-learning.html#cb30-11" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">function</span>(x){<span class="fu">sd</span>(x)<span class="sc">/</span><span class="fu">mean</span>(x)}))</span>
<span id="cb30-12"><a href="unsupervised-learning.html#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="unsupervised-learning.html#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot them as a histogram, and show a line that is used as a threshold</span></span>
<span id="cb30-14"><a href="unsupervised-learning.html#cb30-14" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> cv)) <span class="sc">+</span></span>
<span id="cb30-15"><a href="unsupervised-learning.html#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">color=</span><span class="st">&quot;darkred&quot;</span>, <span class="at">fill=</span><span class="st">&quot;lightblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-16"><a href="unsupervised-learning.html#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;CV&quot;</span>, <span class="at">y =</span> <span class="st">&quot;metabolite frequency&quot;</span>, </span>
<span id="cb30-17"><a href="unsupervised-learning.html#cb30-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Distribution of coefficient of </span></span>
<span id="cb30-18"><a href="unsupervised-learning.html#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="st">       variation of log10 concentration of metabolites&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-19"><a href="unsupervised-learning.html#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> cv_threshold, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-20"><a href="unsupervised-learning.html#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(cv_threshold, <span class="dv">6</span>, <span class="at">label =</span> </span>
<span id="cb30-21"><a href="unsupervised-learning.html#cb30-21" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">paste0</span>(<span class="st">&quot;CV threshold (&quot;</span>, cv_threshold, <span class="st">&quot;)&quot;</span>), <span class="at">vjust =</span> <span class="dv">2</span>, <span class="at">angle=</span><span class="dv">90</span>)) <span class="sc">+</span></span>
<span id="cb30-22"><a href="unsupervised-learning.html#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span>cv_threshold, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-23"><a href="unsupervised-learning.html#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="sc">-</span>cv_threshold, <span class="dv">6</span>, <span class="at">label =</span> </span>
<span id="cb30-24"><a href="unsupervised-learning.html#cb30-24" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">paste0</span>(<span class="st">&quot;CV threshold (&quot;</span>, <span class="sc">-</span>cv_threshold, <span class="st">&quot;)&quot;</span>), <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">angle=</span><span class="dv">90</span>))</span>
<span id="cb30-25"><a href="unsupervised-learning.html#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="unsupervised-learning.html#cb30-26" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="06-unsupML_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Subsetting metabolomic data:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="unsupervised-learning.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get those metabolites that are over threshold</span></span>
<span id="cb31-2"><a href="unsupervised-learning.html#cb31-2" aria-hidden="true" tabindex="-1"></a>metabolites_over_th <span class="ot">&lt;-</span> <span class="fu">rownames</span>(df[df<span class="sc">$</span>cv <span class="sc">&gt;</span> cv_threshold <span class="sc">|</span> </span>
<span id="cb31-3"><a href="unsupervised-learning.html#cb31-3" aria-hidden="true" tabindex="-1"></a>                                     df<span class="sc">$</span>cv <span class="sc">&lt;</span> <span class="sc">-</span>cv_threshold, , <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb31-4"><a href="unsupervised-learning.html#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ignore those metabolites that do not have name / are NA</span></span>
<span id="cb31-5"><a href="unsupervised-learning.html#cb31-5" aria-hidden="true" tabindex="-1"></a>metabolites_over_th <span class="ot">&lt;-</span> metabolites_over_th[<span class="sc">!</span><span class="fu">str_detect</span>(metabolites_over_th, <span class="st">&quot;NA&quot;</span>)]</span></code></pre></div>
<p>After that, we subset microbiome data by filtering rarest taxa off-</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="unsupervised-learning.html#cb32-1" aria-hidden="true" tabindex="-1"></a>rank <span class="ot">&lt;-</span> <span class="st">&quot;Genus&quot;</span></span>
<span id="cb32-2"><a href="unsupervised-learning.html#cb32-2" aria-hidden="true" tabindex="-1"></a>prevalence <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb32-3"><a href="unsupervised-learning.html#cb32-3" aria-hidden="true" tabindex="-1"></a>detection <span class="ot">&lt;-</span> <span class="fl">0.001</span></span>
<span id="cb32-4"><a href="unsupervised-learning.html#cb32-4" aria-hidden="true" tabindex="-1"></a>taxa_trans <span class="ot">&lt;-</span>  <span class="st">&quot;clr&quot;</span></span>
<span id="cb32-5"><a href="unsupervised-learning.html#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="unsupervised-learning.html#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get bacterial data</span></span>
<span id="cb32-7"><a href="unsupervised-learning.html#cb32-7" aria-hidden="true" tabindex="-1"></a>taxa_tse <span class="ot">&lt;-</span> mae[[<span class="dv">1</span>]]</span>
<span id="cb32-8"><a href="unsupervised-learning.html#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Agglomerate at Genus level</span></span>
<span id="cb32-9"><a href="unsupervised-learning.html#cb32-9" aria-hidden="true" tabindex="-1"></a>taxa_tse <span class="ot">&lt;-</span> <span class="fu">agglomerateByRank</span>(taxa_tse, <span class="at">rank =</span> rank)</span>
<span id="cb32-10"><a href="unsupervised-learning.html#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Do CLR transformation</span></span>
<span id="cb32-11"><a href="unsupervised-learning.html#cb32-11" aria-hidden="true" tabindex="-1"></a>taxa_tse <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(taxa_tse, <span class="at">method =</span> <span class="st">&quot;clr&quot;</span>, <span class="at">pseudocount =</span> <span class="dv">1</span>)</span>
<span id="cb32-12"><a href="unsupervised-learning.html#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="unsupervised-learning.html#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset metabolite data</span></span>
<span id="cb32-14"><a href="unsupervised-learning.html#cb32-14" aria-hidden="true" tabindex="-1"></a>metabolite_tse <span class="ot">&lt;-</span> metabolite_tse[metabolites_over_th, ]</span>
<span id="cb32-15"><a href="unsupervised-learning.html#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="unsupervised-learning.html#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset bacterial data by its prevalence. Bacteria whose prevalences are over </span></span>
<span id="cb32-17"><a href="unsupervised-learning.html#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># threshold are included</span></span>
<span id="cb32-18"><a href="unsupervised-learning.html#cb32-18" aria-hidden="true" tabindex="-1"></a>taxa_tse <span class="ot">&lt;-</span> <span class="fu">subsetByPrevalentTaxa</span>(taxa_tse, </span>
<span id="cb32-19"><a href="unsupervised-learning.html#cb32-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">prevalence =</span> prevalence, </span>
<span id="cb32-20"><a href="unsupervised-learning.html#cb32-20" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">detection =</span> detection)</span>
<span id="cb32-21"><a href="unsupervised-learning.html#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="unsupervised-learning.html#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove uncultured and ambiguous(as it&#39;s hard to interpret their results)</span></span>
<span id="cb32-23"><a href="unsupervised-learning.html#cb32-23" aria-hidden="true" tabindex="-1"></a>taxa_tse <span class="ot">&lt;-</span> taxa_tse[<span class="sc">-</span><span class="fu">grep</span>(<span class="st">&quot;uncultured|Ambiguous_taxa&quot;</span>, <span class="fu">names</span>(taxa_tse)),]</span></code></pre></div>
<p>After subsetting, we can perform cross-correlation analysis. With cross-correlation
analysis we can answer the question “If the abundance of this taxon is high, is the
concentration of metabolite high?” for instance.</p>
<p>Check OMA book’s dedicated chapther on
<a href="https://microbiome.github.io/OMA/multi-assay_analyses.html">multi-assay analyses</a>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="unsupervised-learning.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb33-2"><a href="unsupervised-learning.html#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="unsupervised-learning.html#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross correlate data sets</span></span>
<span id="cb33-4"><a href="unsupervised-learning.html#cb33-4" aria-hidden="true" tabindex="-1"></a>correlations <span class="ot">&lt;-</span> <span class="fu">testExperimentCrossCorrelation</span>(taxa_tse, metabolite_tse, </span>
<span id="cb33-5"><a href="unsupervised-learning.html#cb33-5" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">abund_values1 =</span> <span class="st">&quot;clr&quot;</span>, <span class="at">abund_values2 =</span> <span class="st">&quot;nmr&quot;</span>,</span>
<span id="cb33-6"><a href="unsupervised-learning.html#cb33-6" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">method =</span> <span class="st">&quot;spearman&quot;</span>, <span class="at">mode =</span> <span class="st">&quot;matrix&quot;</span>)</span>
<span id="cb33-7"><a href="unsupervised-learning.html#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="unsupervised-learning.html#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># For plotting purpose, convert p-values, under 0.05 are marked with &quot;X&quot;</span></span>
<span id="cb33-9"><a href="unsupervised-learning.html#cb33-9" aria-hidden="true" tabindex="-1"></a>p_threshold <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb33-10"><a href="unsupervised-learning.html#cb33-10" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(correlations<span class="sc">$</span>p_adj<span class="sc">&lt;</span>p_threshold, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb33-11"><a href="unsupervised-learning.html#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="unsupervised-learning.html#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale colors</span></span>
<span id="cb33-13"><a href="unsupervised-learning.html#cb33-13" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">abs</span>(correlations<span class="sc">$</span>cor))), <span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">abs</span>(correlations<span class="sc">$</span>cor))), </span>
<span id="cb33-14"><a href="unsupervised-learning.html#cb33-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">length.out =</span> <span class="fu">ifelse</span>( <span class="fu">max</span>(<span class="fu">abs</span>(correlations<span class="sc">$</span>cor))<span class="sc">&gt;</span><span class="dv">5</span>, </span>
<span id="cb33-15"><a href="unsupervised-learning.html#cb33-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">2</span><span class="sc">*</span><span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">abs</span>(correlations<span class="sc">$</span>cor))), <span class="dv">10</span> ) )</span>
<span id="cb33-16"><a href="unsupervised-learning.html#cb33-16" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">&quot;darkblue&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;white&quot;</span>, </span>
<span id="cb33-17"><a href="unsupervised-learning.html#cb33-17" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;red&quot;</span>, <span class="st">&quot;darkred&quot;</span>))(<span class="fu">length</span>(breaks)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb33-18"><a href="unsupervised-learning.html#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="unsupervised-learning.html#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a heatmap</span></span>
<span id="cb33-20"><a href="unsupervised-learning.html#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(correlations<span class="sc">$</span>cor, <span class="at">display_numbers =</span> p_values,</span>
<span id="cb33-21"><a href="unsupervised-learning.html#cb33-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Correlations between bacteria and metabolites </span></span>
<span id="cb33-22"><a href="unsupervised-learning.html#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="st">              (statistically significant associations (p &lt; 0.05) marked with X)&quot;</span>),</span>
<span id="cb33-23"><a href="unsupervised-learning.html#cb33-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">fontsize =</span> <span class="dv">10</span>,</span>
<span id="cb33-24"><a href="unsupervised-learning.html#cb33-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> breaks,</span>
<span id="cb33-25"><a href="unsupervised-learning.html#cb33-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> colors, </span>
<span id="cb33-26"><a href="unsupervised-learning.html#cb33-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">fontsize_number =</span> <span class="dv">10</span>)</span></code></pre></div>
<p><img src="06-unsupML_files/figure-html/unnamed-chunk-5-1.png" width="768" /></p>
<p>Finally, we can find biclusters from cross-correlation data.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="unsupervised-learning.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load package</span></span>
<span id="cb34-2"><a href="unsupervised-learning.html#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(biclust)</span></code></pre></div>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## 
## Attaching package: &#39;MASS&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<pre><code>## Loading required package: grid</code></pre>
<pre><code>## 
## Attaching package: &#39;grid&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:Biostrings&#39;:
## 
##     pattern</code></pre>
<pre><code>## Loading required package: colorspace</code></pre>
<pre><code>## Loading required package: lattice</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="unsupervised-learning.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find biclusters</span></span>
<span id="cb43-2"><a href="unsupervised-learning.html#cb43-2" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> <span class="fu">biclust</span>(correlations<span class="sc">$</span>cor, <span class="at">method=</span><span class="fu">BCPlaid</span>(), <span class="at">fit.model =</span> y <span class="sc">~</span> m,</span>
<span id="cb43-3"><a href="unsupervised-learning.html#cb43-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">background =</span> <span class="cn">TRUE</span>, <span class="at">shuffle =</span> <span class="dv">100</span>, <span class="at">back.fit =</span> <span class="dv">0</span>, <span class="at">max.layers =</span> <span class="dv">10</span>,</span>
<span id="cb43-4"><a href="unsupervised-learning.html#cb43-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">iter.startup =</span> <span class="dv">10</span>, <span class="at">iter.layer =</span> <span class="dv">100</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-5"><a href="unsupervised-learning.html#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="unsupervised-learning.html#cb43-6" aria-hidden="true" tabindex="-1"></a>bc</span></code></pre></div>
<pre><code>## 
## An object of class Biclust 
## 
## call:
##  biclust(x = correlations$cor, method = BCPlaid(), fit.model = y ~ 
##      m, background = TRUE, shuffle = 100, back.fit = 0, max.layers = 10, 
##      iter.startup = 10, iter.layer = 100, verbose = FALSE)
## 
## Number of Clusters found:  3 
## 
## First  3  Cluster sizes:
##                    BC 1 BC 2 BC 3
## Number of Rows:      12   13    8
## Number of Columns:    3    5    4</code></pre>
<p>To get cluster information into right format, we can use functions from OMA book.
They add cluster for those features that were not assigned to any cluster.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="unsupervised-learning.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Functions for obtaining biclust information</span></span>
<span id="cb45-2"><a href="unsupervised-learning.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="unsupervised-learning.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get clusters for rows and columns</span></span>
<span id="cb45-4"><a href="unsupervised-learning.html#cb45-4" aria-hidden="true" tabindex="-1"></a>.get_biclusters_from_biclust <span class="ot">&lt;-</span> <span class="cf">function</span>(bc, assay){</span>
<span id="cb45-5"><a href="unsupervised-learning.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get cluster information for columns and rows</span></span>
<span id="cb45-6"><a href="unsupervised-learning.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  bc_columns <span class="ot">&lt;-</span> <span class="fu">t</span>(bc<span class="sc">@</span>NumberxCol)</span>
<span id="cb45-7"><a href="unsupervised-learning.html#cb45-7" aria-hidden="true" tabindex="-1"></a>  bc_columns <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(bc_columns)</span>
<span id="cb45-8"><a href="unsupervised-learning.html#cb45-8" aria-hidden="true" tabindex="-1"></a>  bc_rows <span class="ot">&lt;-</span> bc<span class="sc">@</span>RowxNumber</span>
<span id="cb45-9"><a href="unsupervised-learning.html#cb45-9" aria-hidden="true" tabindex="-1"></a>  bc_rows <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(bc_rows)</span>
<span id="cb45-10"><a href="unsupervised-learning.html#cb45-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-11"><a href="unsupervised-learning.html#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get data into right format</span></span>
<span id="cb45-12"><a href="unsupervised-learning.html#cb45-12" aria-hidden="true" tabindex="-1"></a>  bc_columns <span class="ot">&lt;-</span> <span class="fu">.manipulate_bc_data</span>(bc_columns, assay, <span class="st">&quot;col&quot;</span>)</span>
<span id="cb45-13"><a href="unsupervised-learning.html#cb45-13" aria-hidden="true" tabindex="-1"></a>  bc_rows <span class="ot">&lt;-</span> <span class="fu">.manipulate_bc_data</span>(bc_rows, assay, <span class="st">&quot;row&quot;</span>)</span>
<span id="cb45-14"><a href="unsupervised-learning.html#cb45-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-15"><a href="unsupervised-learning.html#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">bc_columns =</span> bc_columns, <span class="at">bc_rows =</span> bc_rows))</span>
<span id="cb45-16"><a href="unsupervised-learning.html#cb45-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-17"><a href="unsupervised-learning.html#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="unsupervised-learning.html#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Input clusters, and how many observations there should be, i.e., the number of samples or features</span></span>
<span id="cb45-19"><a href="unsupervised-learning.html#cb45-19" aria-hidden="true" tabindex="-1"></a>.manipulate_bc_data <span class="ot">&lt;-</span> <span class="cf">function</span>(bc_clusters, assay, row_col){</span>
<span id="cb45-20"><a href="unsupervised-learning.html#cb45-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get right dimension</span></span>
<span id="cb45-21"><a href="unsupervised-learning.html#cb45-21" aria-hidden="true" tabindex="-1"></a>  dim <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(row_col <span class="sc">==</span> <span class="st">&quot;col&quot;</span>, <span class="fu">ncol</span>(assay), <span class="fu">nrow</span>(assay))</span>
<span id="cb45-22"><a href="unsupervised-learning.html#cb45-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get column/row names</span></span>
<span id="cb45-23"><a href="unsupervised-learning.html#cb45-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>( row_col <span class="sc">==</span> <span class="st">&quot;col&quot;</span> ){</span>
<span id="cb45-24"><a href="unsupervised-learning.html#cb45-24" aria-hidden="true" tabindex="-1"></a>    names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(assay)</span>
<span id="cb45-25"><a href="unsupervised-learning.html#cb45-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb45-26"><a href="unsupervised-learning.html#cb45-26" aria-hidden="true" tabindex="-1"></a>    names <span class="ot">&lt;-</span> <span class="fu">rownames</span>(assay)</span>
<span id="cb45-27"><a href="unsupervised-learning.html#cb45-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-28"><a href="unsupervised-learning.html#cb45-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-29"><a href="unsupervised-learning.html#cb45-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no clusters were found, create one. Otherwise create additional cluster which</span></span>
<span id="cb45-30"><a href="unsupervised-learning.html#cb45-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># contain those samples that are not included in clusters that were found.</span></span>
<span id="cb45-31"><a href="unsupervised-learning.html#cb45-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">nrow</span>(bc_clusters) <span class="sc">!=</span> dim ){</span>
<span id="cb45-32"><a href="unsupervised-learning.html#cb45-32" aria-hidden="true" tabindex="-1"></a>      bc_clusters <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cluster =</span> <span class="fu">rep</span>(<span class="cn">TRUE</span>, dim))</span>
<span id="cb45-33"><a href="unsupervised-learning.html#cb45-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb45-34"><a href="unsupervised-learning.html#cb45-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create additional cluster that includes those samples/features that</span></span>
<span id="cb45-35"><a href="unsupervised-learning.html#cb45-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># are not included in other clusters.</span></span>
<span id="cb45-36"><a href="unsupervised-learning.html#cb45-36" aria-hidden="true" tabindex="-1"></a>      vec <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">rowSums</span>(bc_clusters) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>)</span>
<span id="cb45-37"><a href="unsupervised-learning.html#cb45-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If additional cluster contains samples, then add it</span></span>
<span id="cb45-38"><a href="unsupervised-learning.html#cb45-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> ( <span class="fu">any</span>(vec) ){</span>
<span id="cb45-39"><a href="unsupervised-learning.html#cb45-39" aria-hidden="true" tabindex="-1"></a>          bc_clusters <span class="ot">&lt;-</span> <span class="fu">cbind</span>(bc_clusters, vec)</span>
<span id="cb45-40"><a href="unsupervised-learning.html#cb45-40" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb45-41"><a href="unsupervised-learning.html#cb45-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-42"><a href="unsupervised-learning.html#cb45-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust row and column names</span></span>
<span id="cb45-43"><a href="unsupervised-learning.html#cb45-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(bc_clusters) <span class="ot">&lt;-</span> names</span>
<span id="cb45-44"><a href="unsupervised-learning.html#cb45-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(bc_clusters) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(bc_clusters))</span>
<span id="cb45-45"><a href="unsupervised-learning.html#cb45-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bc_clusters)</span>
<span id="cb45-46"><a href="unsupervised-learning.html#cb45-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Then we can use the functions.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="unsupervised-learning.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get biclusters</span></span>
<span id="cb46-2"><a href="unsupervised-learning.html#cb46-2" aria-hidden="true" tabindex="-1"></a>bcs <span class="ot">&lt;-</span> <span class="fu">.get_biclusters_from_biclust</span>(bc, correlations<span class="sc">$</span>cor)</span>
<span id="cb46-3"><a href="unsupervised-learning.html#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="unsupervised-learning.html#cb46-4" aria-hidden="true" tabindex="-1"></a>bicluster_rows <span class="ot">&lt;-</span> bcs<span class="sc">$</span>bc_rows</span>
<span id="cb46-5"><a href="unsupervised-learning.html#cb46-5" aria-hidden="true" tabindex="-1"></a>bicluster_columns <span class="ot">&lt;-</span> bcs<span class="sc">$</span>bc_columns</span>
<span id="cb46-6"><a href="unsupervised-learning.html#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="unsupervised-learning.html#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print biclusters for rows</span></span>
<span id="cb46-8"><a href="unsupervised-learning.html#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bicluster_rows)</span></code></pre></div>
<pre><code>##                               cluster_1 cluster_2 cluster_3 cluster_4
## Genus:Escherichia-Shigella        FALSE     FALSE     FALSE      TRUE
## Genus:Ruminiclostridium 5          TRUE     FALSE      TRUE     FALSE
## Genus:Lactobacillus               FALSE     FALSE     FALSE      TRUE
## Genus:Ruminococcaceae UCG-014      TRUE     FALSE     FALSE     FALSE
## Genus:Lactococcus                 FALSE     FALSE     FALSE      TRUE
## Genus:Mucispirillum               FALSE     FALSE     FALSE      TRUE</code></pre>
<p>Now, we can add bicluster information into the heatmap that we already made.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="unsupervised-learning.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert boolean values into factors</span></span>
<span id="cb48-2"><a href="unsupervised-learning.html#cb48-2" aria-hidden="true" tabindex="-1"></a>bicluster_columns <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">apply</span>(bicluster_columns, <span class="dv">2</span>, as.factor))</span>
<span id="cb48-3"><a href="unsupervised-learning.html#cb48-3" aria-hidden="true" tabindex="-1"></a>bicluster_rows <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">apply</span>(bicluster_rows, <span class="dv">2</span>, as.factor))</span>
<span id="cb48-4"><a href="unsupervised-learning.html#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="unsupervised-learning.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust colors for all clusters</span></span>
<span id="cb48-6"><a href="unsupervised-learning.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>( <span class="fu">ncol</span>(bicluster_rows) <span class="sc">&gt;</span> <span class="fu">ncol</span>(bicluster_columns) ){</span>
<span id="cb48-7"><a href="unsupervised-learning.html#cb48-7" aria-hidden="true" tabindex="-1"></a>  cluster_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(bicluster_rows)</span>
<span id="cb48-8"><a href="unsupervised-learning.html#cb48-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb48-9"><a href="unsupervised-learning.html#cb48-9" aria-hidden="true" tabindex="-1"></a>  cluster_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(bicluster_columns)</span>
<span id="cb48-10"><a href="unsupervised-learning.html#cb48-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-11"><a href="unsupervised-learning.html#cb48-11" aria-hidden="true" tabindex="-1"></a>annotation_colors <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb48-12"><a href="unsupervised-learning.html#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(name <span class="cf">in</span> cluster_names){</span>
<span id="cb48-13"><a href="unsupervised-learning.html#cb48-13" aria-hidden="true" tabindex="-1"></a>  annotation_colors[[name]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;TRUE&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;FALSE&quot;</span> <span class="ot">=</span> <span class="st">&quot;white&quot;</span>)</span>
<span id="cb48-14"><a href="unsupervised-learning.html#cb48-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-15"><a href="unsupervised-learning.html#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="unsupervised-learning.html#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Get correlation values that are over thresholds</span></span>
<span id="cb48-17"><a href="unsupervised-learning.html#cb48-17" aria-hidden="true" tabindex="-1"></a>p_threshold <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb48-18"><a href="unsupervised-learning.html#cb48-18" aria-hidden="true" tabindex="-1"></a>corr_threshold <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb48-19"><a href="unsupervised-learning.html#cb48-19" aria-hidden="true" tabindex="-1"></a>corr_values <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(correlations<span class="sc">$</span>p_adj<span class="sc">&lt;</span>p_threshold <span class="sc">&amp;</span> </span>
<span id="cb48-20"><a href="unsupervised-learning.html#cb48-20" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">abs</span>(correlations<span class="sc">$</span>cor)<span class="sc">&gt;</span>corr_threshold , <span class="fu">round</span>(correlations<span class="sc">$</span>cor,<span class="dv">1</span>), <span class="st">&quot;&quot;</span>)</span>
<span id="cb48-21"><a href="unsupervised-learning.html#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="unsupervised-learning.html#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a heatmap</span></span>
<span id="cb48-23"><a href="unsupervised-learning.html#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(correlations<span class="sc">$</span>cor,</span>
<span id="cb48-24"><a href="unsupervised-learning.html#cb48-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_col =</span> bicluster_columns, </span>
<span id="cb48-25"><a href="unsupervised-learning.html#cb48-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_row =</span> bicluster_rows,</span>
<span id="cb48-26"><a href="unsupervised-learning.html#cb48-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_colors =</span> annotation_colors,</span>
<span id="cb48-27"><a href="unsupervised-learning.html#cb48-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">display_numbers =</span> corr_values,</span>
<span id="cb48-28"><a href="unsupervised-learning.html#cb48-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Correlations between bacteria and metabolites </span></span>
<span id="cb48-29"><a href="unsupervised-learning.html#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="st">              (correlation over threshold (corr &gt; &quot;</span>, corr_threshold,</span>
<span id="cb48-30"><a href="unsupervised-learning.html#cb48-30" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;, p &lt; &quot;</span>, p_threshold,<span class="st">&quot;) marked)&quot;</span>),</span>
<span id="cb48-31"><a href="unsupervised-learning.html#cb48-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">fontsize =</span> <span class="dv">10</span>,</span>
<span id="cb48-32"><a href="unsupervised-learning.html#cb48-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> breaks,</span>
<span id="cb48-33"><a href="unsupervised-learning.html#cb48-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> colors, </span>
<span id="cb48-34"><a href="unsupervised-learning.html#cb48-34" aria-hidden="true" tabindex="-1"></a>               <span class="at">fontsize_number =</span> <span class="dv">6</span>, </span>
<span id="cb48-35"><a href="unsupervised-learning.html#cb48-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">number_color =</span> <span class="st">&quot;yellow&quot;</span>,</span>
<span id="cb48-36"><a href="unsupervised-learning.html#cb48-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_legend =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="06-unsupML_files/figure-html/unnamed-chunk-9-1.png" width="768" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="beta-diversity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="supervised-learning.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["FindingPheno2022_material.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
